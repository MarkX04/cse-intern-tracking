<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CSE Internship Tracking 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" 
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <header class="bg-blue-600 text-white p-4 md:p-5 flex justify-between items-center">
    <div class="flex items-center">
      <img src="https://hcmut.edu.vn/img/nhanDienThuongHieu/01_logobachkhoasang.png" alt="CSE Logo" class="h-8 md:h-12">
      <h1 class="ml-2 md:ml-4 text-lg md:text-xl font-bold">CSE Internship Tracking 2025</h1>
    </div>
  </header>

  <main class="p-4 md:p-5">
    <div class="mb-5">
      <h2 class="text-xl font-semibold mb-3">List of companies</h2>
      <div class="overflow-x-auto">
        <table class="""min-w-full bg-white shadow-md rounded-2xl border border-gray-300 overflow-hidden">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="px-4 py-2 border border-blue-700 ">Short Name</th>
              <th class="px-4 py-2 border border-blue-700">Full Name</th>
              <th class="px-4 py-2 border border-blue-700">Student Register</th>
              <th class="px-4 py-2 border border-blue-700">Max Register</th>
              <th class="px-4 py-2 border border-blue-700">Student Accepted</th>
              <th class="px-4 py-2 border border-blue-700">Max Accepted</th>
            </tr>
          </thead>
          <tbody id="companiesTableBody" class="text-gray-700 border-collapse">
          </tbody>
        </table>
      </div>
    </div>

    <div>
      <h2 class="text-xl font-semibold mb-3">Company tracking</h2>
      <div id="chartContainer" class="w-full h-96 bg-white rounded-lg shadow-md"></div>
    </div>
  </main>

  <footer class="flex justify-between items-center p-4 bg-black text-white">
    <div class="text-left">
        <p>&copy; By @MarkX04. Data collected since 08/04/2025</p>
    </div>
    <div class="flex space-x-4">
        <a href="https://facebook.com/baodai.phamhuynh" target="_blank" class="hover:text-gray-400 transition">
            <i class="fab fa-facebook-f"></i>
        </a>
        <a href="https://github.com/MarkX04" target="_blank" class="hover:text-gray-400 transition">
            <i class="fab fa-github"></i>
        </a>
    </div>
  </footer>

  <script>
    let companiesData = {};
    let historyChart = null; 
    let selectedCompanyId = null;
    function loadCompaniesData() {
      fetch('https://raw.githubusercontent.com/MarkX04/cse-intern-tracking/main/companies.json')
        .then(response => response.json())
        .then(data => {
          companiesData = data;
          populateCompaniesTable(data);
          populateCompanySelect(data);
        })
        .catch(error => console.error('Lỗi tải dữ liệu companies:', error));
    }

    function populateCompaniesTable(data) {
      const tbody = document.getElementById('companiesTableBody');
      tbody.innerHTML = '';
      let companiesArray = Object.values(data);
      
      document.querySelectorAll('thead th').forEach((header, index) => {
      if (index >= 2) {
        header.classList.add('cursor-pointer', 'select-none');
        header.addEventListener('click', () => sortTable(index, companiesArray));
      }
      });
      
      renderCompanyRows(companiesArray, tbody);
    }

    let currentSortColumn = -1;
    let currentSortDirection = 'asc';

    function sortTable(columnIndex, companiesArray) {
      const headers = document.querySelectorAll('thead th');
      const properties = ['shortname', 'fullname', 'studentRegister', 'maxRegister', 'studentAccepted', 'maxAcceptedStudent'];
      
      if (currentSortColumn === columnIndex) {
      currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
      currentSortColumn = columnIndex;
      currentSortDirection = 'asc';
      }
      
      headers.forEach(h => h.classList.remove('after:content-["↑"]', 'after:content-["↓"]', 'after:ml-1'));
      headers[columnIndex].classList.add(
      currentSortDirection === 'asc' ? 'after:content-["↑"]' : 'after:content-["↓"]',
      'after:ml-1'
      );
      
      companiesArray.sort((a, b) => {
      const propA = a[properties[columnIndex]];
      const propB = b[properties[columnIndex]];
      
      if (propA === undefined) return 1;
      if (propB === undefined) return -1;
      
      const comparison = propA - propB;
      return currentSortDirection === 'asc' ? comparison : -comparison;
      });
      
      const tbody = document.getElementById('companiesTableBody');
      renderCompanyRows(companiesArray, tbody);
    }

    function renderCompanyRows(companies, tbody) {
      tbody.innerHTML = '';
      companies.forEach(company => {
        const tr = document.createElement('tr');
        tr.classList.add('hover:bg-gray-100', 'cursor-pointer');
        tr.innerHTML = `
          <td class="border px-4 py-2">${company.shortname || ''}</td>
          <td class="border px-4 py-2">${company.fullname || ''}</td>
          <td class="border px-4 py-2">${company.studentRegister !== undefined ? company.studentRegister : 'N/A'}</td>
          <td class="border px-4 py-2">${company.maxRegister !== undefined ? company.maxRegister : 'N/A'}</td>
          <td class="border px-4 py-2">${company.studentAccepted !== undefined ? company.studentAccepted : 'N/A'}</td>
          <td class="border px-4 py-2">${company.maxAcceptedStudent !== undefined ? company.maxAcceptedStudent : 'N/A'}</td>
        `;
        tr.addEventListener('click', () => {
          selectedCompanyId = company.id;
          loadCompanyHistory(company.id);
        });
        tbody.appendChild(tr);
      });
    }

    function populateCompanySelect(data) {
      const select = document.getElementById('companySelect');
      select.innerHTML = '';
      Object.values(data).forEach(company => {
        const option = document.createElement('option');
        option.value = company.id;
        option.text = company.shortname + ' - ' + company.fullname;
        select.appendChild(option);
      });
      if (select.options.length > 0) {
        selectedCompanyId = select.options[0].value;
        loadCompanyHistory(selectedCompanyId);
      }
      select.addEventListener('change', () => {
        selectedCompanyId = select.value;
        loadCompanyHistory(selectedCompanyId);
      });
    }

    function loadCompanyHistory(companyId) {
      fetch(`https://raw.githubusercontent.com/MarkX04/cse-intern-tracking/main/data_histories/${companyId}.json`)
        .then(response => response.json())
        .then(historyData => {
          if (!Array.isArray(historyData) || historyData.length === 0) {
            console.warn("Không có dữ liệu lịch sử cho công ty:", companyId);
            return;
          }
          historyData.sort((a, b) => a.timestamp - b.timestamp);
          const timestamps = historyData.map(entry => new Date(entry.timestamp * 1000).toLocaleString());
          const studentRegister = historyData.map(entry => entry.studentRegister);
          const studentAccepted = historyData.map(entry => entry.studentAccepted);
          const maxRegister = historyData.map(entry => entry.maxRegister);
          const maxAcceptedStudent = historyData.map(entry => entry.maxAcceptedStudent);
          updateHistoryChart(timestamps, studentRegister, studentAccepted, maxRegister, maxAcceptedStudent);
        })
        .catch(error => console.error('Lỗi tải lịch sử cho công ty ' + companyId, error));
    }

    function updateHistoryChart(labels, studentRegisterData, studentAcceptedData, maxRegisterData, maxAcceptedStudentData) {
      const chartContainer = document.getElementById('chartContainer');
      if (!historyChart) {
        historyChart = echarts.init(chartContainer);
      }
      const chartOption = {
        title: {
          text: 'Company Tracking',
          left: 'center'
        },
        tooltip: {
          trigger: 'axis'
        },
        legend: {
          data: ['Student Register', 'Student Accepted'],
          top: '10%'
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: labels,
          axisLabel: {
            rotate: 45,
            fontSize: 10
          }
        },
        yAxis: {
          type: 'value',
          name: 'Giá trị'
        },
        series: [
          {
            name: 'Student Register',
            type: 'line',
            data: studentRegisterData,
            smooth: true
          },
          {
            name: 'Student Accepted',
            type: 'line',
            data: studentAcceptedData,
            smooth: true
          },
        ]
      };
      historyChart.setOption(chartOption);
      historyChart.resize();
    }

    document.addEventListener('DOMContentLoaded', loadCompaniesData);
  </script>
</body>
</html>
