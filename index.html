<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CSE Internship Tracking 2025</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">
  <header class="bg-blue-600 text-white p-4 md:p-5 flex justify-between items-center">
    <div class="flex items-center">
      <img src="https://hcmut.edu.vn/img/nhanDienThuongHieu/01_logobachkhoasang.png" alt="CSE Logo" class="h-8 md:h-12">
      <h1 class="ml-2 md:ml-4 text-lg md:text-xl font-bold">CSE Internship Tracking 2025</h1>
    </div>
    <div class="links">
      <a href="https://internship.cse.hcmut.edu.vn/" id="homeButton" class="bg-white text-black font-bold py-1 px-2 md:py-2 md:px-4 rounded-full hover:bg-blue-800 transition text-sm md:text-base inline-block">Go to CSE Website</a>
    </div>
  </header>

  <main class="p-4 md:p-5">
    <div class="hero-banner bg-gray-100 relative h-96 overflow-hidden rounded-lg shadow-lg mb-5 flex flex-col md:flex-row border-l-8 border-blue-600">
      <div class="w-full md:w-1/2 p-2 flex flex-col items-center justify-center text-black text-center space-y-4">
        <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 sm:text-5xl md:text-4xl lg:text-6xl xl:text-6xl">
          <span class="block text-blue-600 xl:inline">NỘP CV ĐI EM!</span>
        </h1>
        <div id="quote" class="text-lg md:text-xl max-w-2xl">Còn do dự, mất hết slot đó!</div>
        <p class="text-xl font-semibold text-gray-700">
          Total registers: <span id="totalStudentRegister">0</span> |
          Total intern slots: <span id="totalMaxAccepted">0</span>
        </p>
      </div>
      <div class="w-full md:w-1/2 p-2 relative flex items-center justify-center overflow-hidden rounded">
        <div id="slideshow" class="w-full h-96"></div>
      </div>
    </div>
    
    <div class="mb-5">
      <h2 class="text-xl font-semibold mb-3">List of companies</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white shadow-md rounded-2xl border border-gray-300 overflow-hidden">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="px-4 py-2 border border-blue-700">No.</th>
              <th class="px-4 py-2 border border-blue-700">Short Name</th>
              <th class="px-4 py-2 border border-blue-700">Full Name</th>
              <th class="px-4 py-2 border border-blue-700">Address</th>
              <th class="px-4 py-2 border border-blue-700">Student Register</th>
              <th class="px-4 py-2 border border-blue-700">Max Register</th>
              <th class="px-4 py-2 border border-blue-700">Student Accepted</th>
              <th class="px-4 py-2 border border-blue-700">Max Accepted</th>
              <th class="px-4 py-2 border border-blue-700">Get JD</th>
            </tr>
          </thead>
          <tbody id="companiesTableBody" class="text-gray-700 border-collapse">
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="mb-5">
      <h2 class="text-xl font-semibold mb-3">Company Tracking</h2>
      <div id="chartContainer" class="w-full h-96 bg-white rounded-lg shadow-md"></div>
    </div>
  </main>

  <footer class="flex justify-between items-center p-4 bg-black text-white">
    <div class="text-left">
      <p>&copy; By @MarkX04. Data collected since 08/04/2025</p>
    </div>
    <div class="flex space-x-4">
      <a href="https://facebook.com/baodai.phamhuynh" target="_blank" class="hover:text-gray-400 transition">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a href="https://github.com/MarkX04" target="_blank" class="hover:text-gray-400 transition">
        <i class="fab fa-github"></i>
      </a>
    </div>
  </footer>

  <script>
    let companiesData = {};
    let selectedCompanyId = null;
    let historyChart = null;

    class Slideshow {
      constructor(imageUrls) {
        this.imageUrls = imageUrls;
        this.container = document.getElementById('slideshow');
        this.currentSlide = 0;
        this.slides = [];
        this.totalSlides = 0;
        this.initializeSlideshow();
        this.startSlideshow();
      }
  
      initializeSlideshow() {
        this.imageUrls.forEach((url, index) => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = `Image ${index + 1}`;
          img.className = "absolute inset-0 w-full h-full object-contain object-center rounded-lg shadow-lg transition-opacity duration-1000 ease-in-out " + (index !== 0 ? 'opacity-0' : 'opacity-100');
          this.container.appendChild(img);
          this.slides.push(img);
        });
        this.totalSlides = this.slides.length;
      }
  
      showSlide(index) {
        this.slides.forEach((slide, i) => {
          slide.style.opacity = (i === index) ? '1' : '0';
        });
      }
  
      nextSlide() {
        this.currentSlide = (this.currentSlide + 1) % this.totalSlides;
        this.showSlide(this.currentSlide);
      }
  
      startSlideshow() {
        setInterval(() => this.nextSlide(), 5000);
      }
    }
    
    function updateAggregatedStats(data) {
      let totalStudentRegister = 0;
      let totalMaxAccepted = 0;
      Object.values(data).forEach(company => {
        totalStudentRegister += parseInt(company.studentRegister || 0);
        totalMaxAccepted += parseInt(company.maxAcceptedStudent || 0);
      });
      document.getElementById('totalStudentRegister').textContent = totalStudentRegister.toLocaleString();
      document.getElementById('totalMaxAccepted').textContent = totalMaxAccepted.toLocaleString();
    }
    
    function loadCompaniesData() {
      fetch('https://raw.githubusercontent.com/MarkX04/cse-intern-tracking/main/companies.json')
        .then(response => response.json())
        .then(data => {
          companiesData = data;
          populateCompaniesTable(data);
          updateAggregatedStats(data);
          initializeSlideshowFromCompanies(data);
        })
        .catch(error => console.error('Error loading companies data:', error));
    }
    
    function initializeSlideshowFromCompanies(data) {
      const imageUrls = Object.values(data)
        .map(company => {
          if (company.image) {
            return "https://internship.cse.hcmut.edu.vn" + company.image;
          }
          return null;
        })
        .filter(url => url !== null);
      if (imageUrls.length > 0) {
        new Slideshow(imageUrls);
      }
    }
    
    function populateCompaniesTable(data) {
      const tbody = document.getElementById('companiesTableBody');
      tbody.innerHTML = '';
      const companiesArray = Object.values(data);
      companiesArray.forEach((company, index) => {
        const tr = document.createElement('tr');
        const studentRegister = parseInt(company.studentRegister || 0);
        const maxRegister = parseInt(company.maxRegister || 0);
        const rowBgClass = (studentRegister >= maxRegister) ? 'bg-red-100' : 'bg-green-100';
        tr.classList.add(rowBgClass, 'hover:bg-gray-100', 'cursor-pointer');
  
        tr.innerHTML = `
          <td class="border px-4 py-2 text-center">${index + 1}</td>
          <td class="border px-4 py-2 text-center">${company.shortname || ''}</td>
          <td class="border px-4 py-2 text-center">${company.fullname || ''}</td>
          <td class="border px-4 py-2 text-center">${company.address || 'N/A'}</td>
          <td class="border px-4 py-2 text-center">${company.studentRegister !== undefined ? company.studentRegister : 'N/A'}</td>
          <td class="border px-4 py-2 text-center">${company.maxRegister !== undefined ? company.maxRegister : 'N/A'}</td>
          <td class="border px-4 py-2 text-center">${company.studentAccepted !== undefined ? company.studentAccepted : 'N/A'}</td>
          <td class="border px-4 py-2 text-center">${company.maxAcceptedStudent !== undefined ? company.maxAcceptedStudent : 'N/A'}</td>
          <td class="border px-4 py-2 text-center">
            <button class="bg-blue-600 text-white py-1 px-2 rounded hover:bg-blue-700 transition download-btn">Get JD</button>
          </td>
        `;
  
        tr.querySelector('.download-btn').addEventListener('click', (event) => {
          event.stopPropagation();
          downloadInternshipFiles(company.id);
        });
  
        tr.addEventListener('click', () => {
          selectedCompanyId = company.id;
          loadCompanyHistory(company.id);
        });
  
        tbody.appendChild(tr);
      });
    }
    
    function downloadInternshipFiles(companyId) {
      const company = companiesData[companyId];
      if (!company) {
        console.error("No data found for company", companyId);
        return;
      }
      if (company.internshipFiles && company.internshipFiles.length > 0) {
        company.internshipFiles.forEach(file => {
          const fileUrl = "https://internship.cse.hcmut.edu.vn" + file.path.split('?')[0];
          const a = document.createElement('a');
          a.href = fileUrl;
          a.download = file.name; 
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });
      } else {
        alert("No internship files available for download for this company.");
      }
    }
    
    function loadCompanyHistory(companyId) {
      fetch(`https://raw.githubusercontent.com/MarkX04/cse-intern-tracking/main/data_histories/${companyId}.json`)
        .then(response => response.json())
        .then(historyData => {
          if (!Array.isArray(historyData) || historyData.length === 0) {
            console.warn("No history data for company:", companyId);
            return;
          }
          historyData.sort((a, b) => a.timestamp - b.timestamp);
          const labels = historyData.map(entry => new Date(entry.timestamp * 1000).toLocaleString());
          const studentRegister = historyData.map(entry => entry.studentRegister);
          const studentAccepted = historyData.map(entry => entry.studentAccepted);
          const maxRegister = historyData.map(entry => entry.maxRegister);
          const maxAcceptedStudent = historyData.map(entry => entry.maxAcceptedStudent);
          updateHistoryChart(labels, studentRegister, studentAccepted, maxRegister, maxAcceptedStudent);
        })
        .catch(error => console.error("Error loading history for company " + companyId, error));
    }
    
    function updateHistoryChart(labels, studentRegisterData, studentAcceptedData, maxRegisterData, maxAcceptedStudentData) {
      const chartContainer = document.getElementById('chartContainer');
      if (!historyChart) {
        historyChart = echarts.init(chartContainer);
      }
      const chartOption = {
        title: {
          text: 'Company Tracking',
          left: 'center'
        },
        tooltip: {
          trigger: 'axis'
        },
        legend: {
          data: ['Student Register', 'Student Accepted'],
          top: '10%'
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          boundaryGap: false,
          data: labels,
          axisLabel: {
            rotate: 45,
            fontSize: 10
          }
        },
        yAxis: {
          type: 'value',
          name: 'Value'
        },
        series: [
          {
            name: 'Student Register',
            type: 'line',
            data: studentRegisterData,
            smooth: true
          },
          {
            name: 'Student Accepted',
            type: 'line',
            data: studentAcceptedData,
            smooth: true
          }
        ]
      };
      historyChart.setOption(chartOption);
      historyChart.resize();
    }
    
    function fetchRealTimeData() {
      fetch("http://127.0.0.1:5001/api/company_data")
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error("API error:", data.error);
            return;
          }
          updateAggregatedUI(data);
        })
        .catch(error => {
          console.error("Error fetching real-time data:", error);
        });
    }
    
    function updateAggregatedUI(data) {
      let totalStudentRegister = 0;
      let totalMaxAccepted = 0;
      Object.values(data).forEach(company => {
        totalStudentRegister += parseInt(company.studentRegister || 0);
        totalMaxAccepted += parseInt(company.maxAcceptedStudent || 0);
      });
      document.getElementById("totalStudentRegister").textContent = totalStudentRegister.toLocaleString();
      document.getElementById("totalMaxAccepted").textContent = totalMaxAccepted.toLocaleString();
    }
    
    window.addEventListener('resize', function() {
      const slideshow = document.getElementById('slideshow');
      if (slideshow) {
        slideshow.style.height = '100%';
      }
      if (historyChart) {
        historyChart.resize();
      }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
      loadCompaniesData();
      fetchRealTimeData();
      setInterval(fetchRealTimeData, 60000);
    });
  </script>
</body>
</html>
